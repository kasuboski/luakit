local builder = bk.image("golang:1.22")
local src = bk.local_("context")
local deps = builder:copy(src, "go.mod", "/app/go.mod"):copy(src, "go.sum", "/app/go.sum")
local downloaded = deps:run("go mod download", { cwd = "/app", mounts = { bk.cache("/root/.cache/go-build") } })
local workspace = downloaded:copy(src, ".", "/app")
local lint = workspace:run("golangci-lint run ./...", { cwd = "/app" })
local test = workspace:run("go test ./...", { cwd = "/app" })
local build = workspace:run("go build -o /out/server ./cmd/server", { cwd = "/app" })
local merged = bk.merge(lint, test, build)
local runtime = bk.image("gcr.io/distroless/static:nonroot")
local final = runtime:copy(merged, "/out/server", "/server")
bk.export(final, { entrypoint = {"/server"}, user = "nonroot" })
