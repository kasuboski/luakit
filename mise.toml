[env]
GOFLAGS = "-v"
mise.file = ".env"

[tools]
go = 'prefix:1.25'

[vars]
binary_name = "luakit"
dist_dir = "dist"

[tasks.build]
description = "Build the binary for the current platform"
sources = ["**/*.go", "go.mod", "go.sum"]
outputs = ["{{vars.dist_dir}}/{{vars.binary_name}}"]
run = '''
set -e
VERSION=$(git describe --tags --always 2>/dev/null || echo "dev")
BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
GOOS="${GOOS:-$(go env GOOS)}"
GOARCH="${GOARCH:-$(go env GOARCH)}"

echo "Building {{vars.binary_name}} for $GOOS/$GOARCH..."
mkdir -p {{vars.dist_dir}}
go build $GOFLAGS -ldflags "-s -w -X main.version=$VERSION -X main.buildTime=$BUILD_TIME -X main.commit=$COMMIT" -o {{vars.dist_dir}}/{{vars.binary_name}} ./cmd/luakit
echo "Binary built: {{vars.dist_dir}}/{{vars.binary_name}}"
'''

[tasks."build:linux-amd64"]
description = "Build for Linux amd64"
env = { GOOS = "linux", GOARCH = "amd64" }
run = "mise run build"

[tasks."build:linux-arm64"]
description = "Build for Linux arm64"
env = { GOOS = "linux", GOARCH = "arm64" }
run = "mise run build"

[tasks."build:darwin-amd64"]
description = "Build for macOS amd64"
env = { GOOS = "darwin", GOARCH = "amd64" }
run = "mise run build"

[tasks."build:darwin-arm64"]
description = "Build for macOS arm64"
env = { GOOS = "darwin", GOARCH = "arm64" }
run = "mise run build"

[tasks.build-all]
description = "Build binaries for all target platforms"
depends = ["build:linux-amd64", "build:linux-arm64", "build:darwin-amd64", "build:darwin-arm64"]

[tasks.checksums]
description = "Generate SHA256 checksums for release artifacts"
run = '''
echo "Generating SHA256 checksums..."
cd {{vars.dist_dir}} && shasum -a 256 {{vars.binary_name}}-* > checksums.txt
echo "Checksums generated: {{vars.dist_dir}}/checksums.txt"
'''

[tasks.release]
description = "Build release artifacts for all platforms"
depends = ["build-all", "checksums"]

[tasks.test]
description = "Run tests"
run = "go test -v -race -coverprofile=coverage.out -covermode=atomic ./..."

[tasks."test:integration"]
description = "Run integration tests with BuildKit"
run = '''
#!/usr/bin/env bash
set -e

if [ -z "$BUILDKIT_HOST" ] && [ ! -S /run/buildkit/buildkitd.sock ]; then
    echo "Error: BuildKit daemon not running"
    echo "Start with: mise run buildkit:start"
    exit 1
fi

scripts/start-buildkit.sh
trap 'scripts/stop-buildkit.sh' EXIT

go test -tags=e2e -v -timeout=15m ./test/integration/...
'''

[tasks."test:coverage"]
description = "Generate coverage report"
run = '''
go test -race -coverprofile=coverage.out -covermode=atomic ./...
go tool cover -html=coverage.out -o coverage.html
'''

[tasks.clean]
description = "Clean build artifacts"
run = '''
echo "Cleaning build artifacts..."
rm -rf {{vars.dist_dir}}
rm -f coverage.out coverage.html
echo "Clean complete"
'''

[tasks.install]
description = "Install the binary to GOPATH/bin"
run = '''
set -e
VERSION=$(git describe --tags --always 2>/dev/null || echo "dev")
BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")

echo "Installing {{vars.binary_name}} to $(go env GOPATH)/bin..."
go install $GOFLAGS -ldflags "-s -w -X main.version=$VERSION -X main.buildTime=$BUILD_TIME -X main.commit=$COMMIT" ./cmd/luakit
echo "Installed successfully"
'''

[tasks.fmt]
description = "Format code"
run = "go fmt ./..."

[tasks.lint]
description = "Run linter"
run = '''
if command -v golangci-lint >/dev/null 2>&1; then
    golangci-lint run ./...
else
    echo "golangci-lint not found. Install it from https://golangci-lint.run/usage/install/"
    exit 1
fi
'''

[tasks.vet]
description = "Run go vet"
run = "go vet ./..."

[tasks.benchmark]
description = "Run benchmarks"
run = "go test -bench=. -benchmem -benchtime=10s ./..."

[tasks.run]
description = "Build and run the binary"
depends = ["build"]
run = "{{vars.dist_dir}}/{{vars.binary_name}} version"

[tasks."docker:build"]
description = "Build Docker image"
run = '''
echo "Building Docker image..."
docker build -t {{vars.binary_name}}:latest .
echo "Docker image built: {{vars.binary_name}}:latest"
'''

[tasks."docker:run"]
description = "Run Docker container"
depends = ["docker:build"]
run = "docker run --rm {{vars.binary_name}}:latest version"

[tasks."buildkit:start"]
description = "Start BuildKit daemon"
run = "scripts/start-buildkit.sh"

[tasks."buildkit:stop"]
description = "Stop BuildKit daemon"
run = "scripts/stop-buildkit.sh"

[tasks."verify:release"]
description = "Verify release artifacts"
run = '''
echo "Verifying release artifacts..."
cd {{vars.dist_dir}}
for artifact in {{vars.binary_name}}-*; do
    echo "Verifying $artifact..."
    $artifact version
done
echo "All release artifacts verified"
'''

[tasks.go-modernize]
description = "Automatically modernize Go code"
run = 'go run golang.org/x/tools/go/analysis/passes/modernize/cmd/modernize@latest -fix ./...'
